<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kamishibai: The Story of a Hundred Lights</title>
<style>
  :root{ --w:640px; --fg:#fff; --acc:#ffd54a; }
  *{ box-sizing:border-box }
  body{
    margin:0; background:#111; color:var(--fg);
    font-family: system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",Meiryo,sans-serif;
    display:flex; min-height:100vh; align-items:center; justify-content:center; padding:16px;
  }
  .app{ width:min(var(--w),95vw); }
  .bar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:10px 0; }
  .sp{ flex:1 }
  select,button,label{
    background:#1a1a1a; color:#fff; border:1px solid #333; border-radius:10px; padding:8px 12px; font-size:14px;
  }
  button.primary{ background:var(--acc); color:#222; border-color:#cc9; }
  button.ghost{ background:#1a1a1a; }
  button:disabled{ opacity:.5; cursor:not-allowed; }

  .stage{ position:relative; width:100%; background:#000; border:1px solid #222; border-radius:12px; overflow:hidden; }
  .stage::before{ content:""; display:block; padding-top:56.25%; }  /* 16:9 */
  .viewport{ position:absolute; inset:0; }

  #displayImg{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain; display:block; }
  #overlayImg{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; opacity:0; transition:opacity 1.2s ease; }

  /* 49グリッド */
  .grid7{ position:absolute; inset:0; display:none; }
  .grid7 .tile{
    position:absolute; background-repeat:no-repeat;
    opacity:0; transition: transform 1.2s ease, opacity 1.2s ease;
    will-change: transform, opacity;
  }

  /* ナレーション（Intro時に重ねる短文） */
  .narr{
    position:absolute; left:50%; transform:translateX(-50%); bottom:72px;
    background:rgba(0,0,0,.85); padding:12px 16px; border-radius:10px; font-weight:700;
    opacity:0; transition:opacity .8s ease; z-index:3; white-space:pre-wrap;
  }

/* 追加 or 置換 */
.caption{
  position:absolute; left:0; right:0; bottom:8px; /* ← ここを 0 → 8px */
  padding:10px 12px;
  background:linear-gradient(180deg,rgba(0,0,0,0) 0%,rgba(0,0,0,.65) 40%,rgba(0,0,0,.85) 100%);
  font-size:18px; line-height:1.7; white-space:pre-wrap;
}

/* 一行目だけ3文字ぶん右へ（E0用） */
.indent3{ text-indent:3ch; }

  /* エンディングの「おしまい」ボタン */
  .endwrap{
    position:absolute; inset:0; display:grid; place-items:end center; padding-bottom:18px; z-index:4;
  }
  .endwrap button{
    padding:10px 20px; font-size:18px; color:#fff; background:#333; border:1px solid #777; border-radius:8px;
  }
  .endwrap button:hover{ background:#555; }
</style>
</head>
<body>
<div class="app">
  <div class="bar">
    <button id="prev" class="ghost">◀ Prev</button>

    <label>Pick
      <select id="pick">
        <option value="INTRO" selected>Intro — The Color of Flowers (49+2 layers)</option>
        <option value="S1">S1 — Scene 11</option>
        <option value="S2">S2 — Scene 12</option>
        <option value="S3">S3 — Scene 13</option>
        <option value="S4">S4 — Scene 14</option>
        <option value="S5">S5 — Scene 15</option>
        <option value="E0">E0 — Cover</option>
        <option value="E1">E1 — Episode 1</option>
        <option value="E2">E2 — Episode 2</option>
        <option value="E3">E3 — Episode 3</option>
        <option value="E4">E4 — Episode 4</option>
        <option value="E5">E5 — Episode 5</option>
        <option value="E6">E6 — Episode 6</option>
        <option value="E7">E7 — Episode 7</option>
        <option value="E8">E8 — Episode 8</option>
        <option value="END">END — The End</option>
      </select>
    </label>

    <button id="show" class="primary">Show</button>
    <button id="next" class="ghost">Next ▶</button>
    <div class="sp"></div>
  </div>

  <div class="stage">
    <div class="viewport" id="vp">
      <img id="displayImg" alt="">
      <img id="overlayImg" alt="">
      <div id="grid" class="grid7"></div>
      <div id="narr" class="narr">This poem hides a secret story.</div>
      <div class="caption" id="cap"></div>
    </div>
  </div>
</div>

<script>
(function(){
  /* ---------- Subtitle Data ---------- */
  const subtitlesKomachi = [
    { image: "scene11.jpg", text: "If you light the lamps for a hundred nights, then… I shall accept your feelings." },
    { image: "scene12.jpg", text: "Fujihara no Sanetaka climbed the freezing hill even in stormy nights—carrying the promise with Komachi in his heart." },
    { image: "scene13.jpg", text: "On the 99th night, he lit the lamp even while bedridden. That light was the flame of his very life." },
    { image: "scene14.jpg", text: "On the 100th morning, his lifeless body lay beneath the final lantern… the last light left unlit." },
    { image: "scene15.jpg", text: "The true darkness was not in the night, but in the heart that couldn’t believe in love. Now… let me light the final lamp." }
  ];
  const subtitlesEgypt = [
    { image: "egypt0.jpg", text: "There is a similar story told in ancient Egypt." },
    { image: "egypt1.jpg", text: "Nefertis: A priestess of divine beauty who served the temple. Though loyal to the king, she longed for freedom deep in her heart." },
    { image: "egypt2.jpg", text: "Aknam: A young soldier. His heart was devoted solely to Nefertis." },
    { image: "egypt3.jpg", text: "\"If you light the lamps for a hundred nights—then I shall accept your feelings.\" },
    { image: "egypt4.jpg", text: "Through storms, Aknam climbed the freezing hill each night, carrying the promise with Nefertis in his heart." },
    { image: "egypt5.jpg", text: "On the 99th night, he fell into the river on his return. That light was his very life’s flame." },
    { image: "egypt6.jpg", text: "On the 100th morning, Nefertis found his cold body by the riverside. \"Why... why did you have to die?\"" },
    { image: "egypt7.jpg", text: "She wept. The final lamp remained unlit, alone in the dawn." },
    { image: "egypt8.jpg", text: "When will this long rain and my tears ever stop?" }
  ];

  /* ---------- UI ---------- */
  const pick = document.getElementById('pick');
  const showBtn = document.getElementById('show');
  const prevBtn = document.getElementById('prev');
  const nextBtn = document.getElementById('next');
  const vp = document.getElementById('vp');

  const displayImg = document.getElementById('displayImg');
  const overlayImg = document.getElementById('overlayImg');
  const grid = document.getElementById('grid');
  const cap = document.getElementById('cap');
  const narr = document.getElementById('narr');

  const preload = url => new Promise(res => { if(!url){res(false);return;} const i=new Image(); i.onload=()=>res(true); i.onerror=()=>res(false); i.src=url; });

  /* ---------- 49 Tiles ---------- */
  function gridAssemble(src){
    grid.style.display='block';
    grid.innerHTML='';
    const rect = vp.getBoundingClientRect();
    const W=Math.max(1,rect.width), H=Math.max(1,rect.height);
    if(W<2||H<2){ grid.style.display='none'; return false; }
    const N=7, cw=W/N, ch=H/N;
    const tiles=[];
    for(let y=0;y<N;y++){
      for(let x=0;x<N;x++){
        const d=document.createElement('div');
        d.className='tile';
        d.style.left=(x*cw)+'px';
        d.style.top =(y*ch)+'px';
        d.style.width =Math.ceil(cw)+'px';
        d.style.height=Math.ceil(ch)+'px';
        d.style.backgroundImage=`url(${src})`;
        d.style.backgroundSize=`${W}px ${H}px`;
        d.style.backgroundPosition=`-${x*cw}px -${y*ch}px`;
        const jitterX=(Math.random()-0.5)*W*0.9;
        const jitterY=(Math.random()-0.5)*H*0.9;
        const rot=(Math.random()-0.5)*60;
        d.style.transform=`translate(${jitterX}px, ${jitterY}px) rotate(${rot}deg)`;
        d.style.opacity=0;
        d.style.transitionDelay=(Math.random()*500)+'ms';
        grid.appendChild(d); tiles.push(d);
      }
    }
    void grid.offsetWidth;
    requestAnimationFrame(()=>requestAnimationFrame(()=>{
      for(const d of tiles){ d.style.transform='translate(0,0) rotate(0)'; d.style.opacity=1; }
    }));
    return true;
  }

  function resetView(){
    grid.style.display='none'; grid.innerHTML='';
    overlayImg.style.opacity=0; overlayImg.src='';
    displayImg.src=''; displayImg.style.display='block';
    narr.style.opacity=0;
    cap.textContent='';
    // Remove the end button if it exists
    const oldEnd = vp.querySelector('.endwrap'); if(oldEnd) oldEnd.remove();
  }

  /* ---------- Resolve Function (Pick -> Display Structure) ---------- */ 
function resolve(key){
    if(key==='INTRO'){
      return {
        type:'intro',
        cover: 'intro_cover_49.jpg',
        bg1: 'background_after_intro.jpg',  // ← 追加
        bg2: 'second_background.jpg',
        text: 'This poem hides a secret story.'
      };
    }
    if(/^S([1-5])$/.test(key)){
      const n=+RegExp.$1;
      return { type:'scene', src:`scene${n}.jpg`, text: (subtitlesKomachi[n-1]?.text||'') };
    }
    if(/^E([0-8])$/.test(key)){
      const n=+RegExp.$1;
      return { type:'episode', src:`egypt${n}.jpg`, text: (subtitlesEgypt[n]?.text||'') };
    }
    if(key==='END'){
      return { type:'end', src:'story_end.jpg', text:'' };
    }
    return { type:'none' };
  }

  /* ---------- Display Functions ---------- */
async function playIntro(cfg){
  resetView();

  // 画像をプリロード
  const hasCover = await preload(cfg.cover);
  const hasBg1   = await preload(cfg.bg1);
  const hasBg2   = await preload(cfg.bg2);

  // 49分割アニメーションを開始
  if(hasCover){ gridAssemble(cfg.cover); }

  // アニメーション完了後の処理
  setTimeout(()=>{
    // グリッドを非表示に
    grid.innerHTML = '';
    grid.style.display = 'none';

    // 1. 最初の背景 (background_after_intro.jpg) を表示
    if(hasBg1){
      displayImg.style.display = 'block';
      displayImg.src = cfg.bg1;
    }

    // 2. 2秒待ってから、次の処理へ進む  <-- 変更点
    setTimeout(() => {
      // 2枚目の背景をオーバーレイで重ね、ナレーションを表示
      if(hasBg2){
        overlayImg.src = cfg.bg2;
        overlayImg.style.opacity = 1; // フェードイン開始
      }
      narr.textContent = cfg.text || '';
      narr.style.opacity = 1;
    }, 2000); // 2000ミリ秒 = 2秒

    cap.textContent = '';
  }, hasCover ? 1600 : 0);
}

  function showScene(src, text){
    resetView();
    const ok = gridAssemble(src);
    if(!ok){ displayImg.src = src; }
    cap.textContent = text||'';
  }

function showEpisode(src, text, opt={}){
  resetView();
  displayImg.src = src;
  cap.classList.toggle('indent3', !!opt.indentFirstLine);
  cap.textContent = text || '';
}

  async function showEnd(src){
    resetView();
    const ok = await preload(src);
    if(ok) displayImg.src = src;
    
    const wrap = document.createElement('div');
    wrap.className = 'endwrap';
    const btn = document.createElement('button');
    btn.textContent = 'The End';
    btn.onclick = ()=>{}; // Does nothing
    wrap.appendChild(btn);
    vp.appendChild(wrap);
  }

  /* ---------- Main Render & Navigation ---------- */
function render(){
  const sel = resolve(pick.value);
  if(sel.type==='intro')   return playIntro(sel);
  if(sel.type==='scene')   return showScene(sel.src, sel.text);
  if(sel.type==='episode'){
    const indent = (pick.value === 'E0');
    return showEpisode(sel.src, sel.text, { indentFirstLine: indent });
  }
  if(sel.type==='end')     return showEnd(sel.src);
  cap.textContent = 'Image not found';
}

  function movePick(d){
    const opts=[...pick.options], i=pick.selectedIndex;
    const j=Math.min(opts.length-1, Math.max(0, i+d));
    pick.selectedIndex=j; render();
  }

  /* ---------- Events ---------- */
  document.getElementById('show').onclick = render;
  document.getElementById('prev').onclick = ()=> movePick(-1);
  document.getElementById('next').onclick = ()=> movePick(+1);
  pick.onchange = ()=> render();
  document.addEventListener('DOMContentLoaded', ()=> setTimeout(render, 0));
})();
</script>
</body>
</html>
