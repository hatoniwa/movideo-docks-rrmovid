<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hyakunin Isshu â€” Ultimate Viewer (MP4-first)</title>
<style>
  :root{
    --w:720px; --fg:#fff; --ui:#1a1a1a; --bd:#333; --acc:#ffd54a;
    --btn:#ccc; --btnText:#3fa34d; --shadow:0 8px 24px rgba(0,0,0,.35);
    --aspect:56.25%;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:#101014; color:var(--fg);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", Meiryo, sans-serif;
    min-height:100vh; display:flex; align-items:center; justify-content:center; padding:18px;
  }
  .app{ width:min(var(--w), 96vw); }
  .bar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:8px 0 12px; }
  label, select, button{
    background:var(--ui); color:#fff; border:1px solid var(--bd); border-radius:10px;
    padding:8px 12px; font-size:14px;
  }
  select,button{ cursor:pointer }
  .ghost{ opacity:.65 }

  .stage{
    position:relative; width:100%; border:1px solid #222; border-radius:14px;
    background:#000; overflow:hidden; box-shadow:var(--shadow);
  }
  .stage::before{ content:""; display:block; padding-top:var(--aspect); } /* 16:9 */
  .viewport{ position:absolute; inset:0; }

  /* ç”»åƒãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ */
  #displayImg{ width:100%; height:100%; object-fit:contain; display:none; }

  /* 49ã‚¿ã‚¤ãƒ«ï¼ˆjpgæ™‚ï¼‰ */
  .grid7{ position:absolute; inset:0; display:none; }
  .grid7 .tile{
    position:absolute; background-repeat:no-repeat;
    transition: transform 1.05s ease, opacity 1.05s ease;
    will-change: transform, opacity;
  }

  /* å‹•ç”»ï¼ˆmp4æ™‚ï¼‰ */
  #videoWrap{ position:absolute; inset:0; display:none; }
  #video{
    width:100%; height:100%; object-fit:cover; display:block;
    background:#000;
  }
  .videoControls{
    position:absolute; left:12px; bottom:12px; display:flex; gap:8px; z-index:5;
    background:rgba(0,0,0,.55); border:1px solid #444; border-radius:10px; padding:6px 8px;
  }
  .videoControls button{ background:#1b1b1f; border:1px solid #2f2f33; border-radius:8px; padding:6px 10px; }

  /* ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå¶æ•°ï¼‰ */
  .text-overlay{
    position:absolute; inset:0; display:none;
    flex-direction:column; justify-content:center; align-items:center; text-align:center;
    padding:20px; background:rgba(0,0,0,.72); color:#fff; line-height:1.6; font-size:20px;
    opacity:0; transition:opacity .45s ease; white-space:pre-line;
  }
  .text-overlay p{ margin:0 }
  .text-overlay .author{ margin-top:10px; color:var(--acc); font-style:italic; font-size:16px }

  /* ãƒ„ãƒ¼ãƒ«ç¾¤ */
  .tools{ position:absolute; left:12px; top:12px; display:flex; gap:6px; z-index:5; }
  .tools button{ background:#1b1b1f; border-color:#2f2f33; padding:6px 10px; border-radius:8px; font-size:13px }
  .nav{ position:absolute; right:12px; top:12px; display:flex; gap:6px; z-index:5; }
  .nav button{ background:#1b1b1f; border-color:#2f2f33; padding:6px 10px; border-radius:8px; font-size:13px }

  /* ãƒ˜ãƒ«ãƒ— / ã‚¿ãƒƒãƒ— */
  .help{
    position:absolute; inset:auto 12px 12px 12px; padding:10px 12px;
    background:rgba(0,0,0,.65); border:1px solid #444; border-radius:10px; font-size:13px; display:none;
  }
  #tapBtn{
    position:absolute; left:16px; bottom:16px; z-index:6;
    background:var(--btn); color:var(--btnText); border:1px solid #999; border-radius:10px;
    font-weight:800; font-size:14px; padding:10px 14px;
  }

  /* èª˜å°/ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ */
  .notice{
    position:absolute; inset:0; display:none; flex-direction:column; gap:14px;
    justify-content:center; align-items:center; text-align:center;
    background:rgba(0,0,0,.85); color:#fff; font-weight:700; font-size:20px; padding:20px;
  }
  .notice a{
    display:inline-block; padding:10px 14px; border-radius:8px; text-decoration:none;
    background:var(--btn); color:var(--btnText); border:1px solid #999; font-weight:700;
  }
  .caption{
    position:absolute; left:0; right:0; bottom:0; padding:10px 12px;
    background:linear-gradient(180deg,rgba(0,0,0,0) 0%,rgba(0,0,0,.65) 45%,rgba(0,0,0,.78) 100%);
    font-size:13px; color:#ddd;
  }
</style>
</head>
<body>
<div class="app">
  <div class="bar">
    <label>Pick
      <select id="pick">
        <option value="A01">A01 â€” Komachi (art/mp4)</option>
        <option value="A02">A02 â€” Komachi (Text)</option>
        <option value="A03">A03 â€” RyÅzen (art/mp4)</option>
        <option value="A04">A04 â€” RyÅzen (Text)</option>
        <option value="A05">A05 â€” Sosei (art/mp4)</option>
        <option value="A06">A06 â€” Sosei (Text)</option>
        <option value="A07">A07 â€” Akahito (art/mp4)</option>
        <option value="A08">A08 â€” Akahito (Text)</option>
        <option value="A09">A09 â€” Atsutada (art/mp4)</option>
        <option value="A10">A10 â€” Atsutada (Text)</option>
        <option value="A11">A11 â€” SaigyÅ (art/mp4)</option>
        <option value="A12">A12 â€” SaigyÅ (Text)</option>
        <option value="A13">A13 â€” ÅŒe no Chisato (art/mp4)</option>
        <option value="A14">A14 â€” ÅŒe no Chisato (Text)</option>
        <option value="A15">A15 â€” Sagami (art/mp4)</option>
        <option value="A16" selected>A16 â€” Sagami (Text)</option>
      </select>
    </label>

    <label>Mode
      <select id="mode">
        <option value="auto" selected>Autoï¼ˆodd=video/img / even=textï¼‰</option>
        <option value="explain">Explain only</option>
        <option value="notice">ğŸ‘‰ Check the description</option>
      </select>
    </label>

    <label>Lyrics
      <select id="lyricsMode">
        <option value="en" selected>English</option>
        <option value="hira">ã²ã‚‰ãŒãª</option>
      </select>
    </label>

    <span class="sp"></span>
    <label class="ghost"><input type="checkbox" id="autoPair" checked /> Pair advance</label>
  </div>

  <div class="stage">
    <div class="viewport" id="vp">

      <!-- å·¦ä¸Šãƒ„ãƒ¼ãƒ« -->
      <div class="tools">
        <button id="speakJaBtn">ğŸ”Š JA</button>
        <button id="speakEnBtn">ğŸ”Š EN</button>
        <button id="explainBtn">â„¹ Explain</button>
        <button id="openLinkBtn">â†— Open</button>
      </div>

      <!-- å³ä¸ŠãƒŠãƒ“ -->
      <div class="nav">
        <button id="prevBtn">â® Prev</button>
        <button id="nextBtn">â­ Next</button>
      </div>

      <!-- æ˜ åƒè¡¨ç¤ºï¼ˆå„ªå…ˆï¼‰ -->
      <div id="videoWrap">
        <video id="video" playsinline loop></video>
        <div class="videoControls" id="vctrl" style="display:none;">
          <button id="togglePlay">â–¶/â¸</button>
          <button id="toggleMute">ğŸ”‡/ğŸ”Š</button>
        </div>
      </div>

      <!-- ç”»åƒãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ -->
      <img id="displayImg" alt="">
      <div id="grid" class="grid7"></div>

      <!-- ãƒ†ã‚­ã‚¹ãƒˆ -->
      <div id="textOverlay" class="text-overlay"></div>

      <div id="help" class="help">
        Tapã€ŒTap Hereã€to start.  
        With odd items: video (if exists) or exploding image. Even items: EN / ã²ã‚‰ãŒãª text, ğŸ”Š to listen.
      </div>

      <button id="tapBtn" type="button">Tap Here</button>

      <div class="notice" id="notice">
        ğŸ‘‰ This is not the end!<br>
        Please open the description link below.
        <a id="noticeLink" href="https://hatoniwa.github.io/movideo/docks/a/gameC.html" target="_blank" rel="noopener">Open Interactive Page â†—</a>
      </div>

      <div id="caption" class="caption"></div>
    </div>
  </div>
</div>

<script>
/* ========= ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆç¬¬äºŒéƒ¨Bã‹ã‚‰ç¶™æ‰¿ï¼‰ ========= */
const TEXT_EN = {
  "A02": `The colors of flowers fade away in vain,
as in this fleeting world my life drifts on in rains.
â€” Ono no Komachi`,
  "A04": `Lonely, I stepped outside my hut and lookedâ€”
everywhere the same: an autumn evening.
â€” RyÅzen HÅshi`,
  "A06": `â€œI'll come tonight,â€ you said â€” so I stayed awake,
waiting for the long-month's dawning moon.
â€” Sosei HÅshi`,
  "A08": `At Tago Bay I came out and beheld:
pure white snow on Fujiâ€™s lofty peak.
â€” Yamabe no Akahito`,
  "A10": `Compared with how my heart has been since we met,
in former days I scarcely knew longing.
â€” Fujiwara no Atsutada`,
  "A12": `â€œLament!â€â€”does the moon make me grieve?
Noâ€”my tears themselves blame the moon.
â€” SaigyÅ`,
  "A14": `Seeing the moon, a thousand sorrows surgeâ€”
though autumn is not mine alone.
â€” ÅŒe no Chisato`,
  "A16": `Weary of resentment, though even dry sleeves remain,
my name will wither away in loveâ€™s decay.
â€” Sagami`
};
const TEXT_HIRA = {
  "A02": `ã¯ãªã®ã„ã‚ã¯ ã†ã¤ã‚Šã«ã‘ã‚Šãª ã„ãŸã¥ã‚‰ã«
ã‚ãŒã¿ã‚ˆã«ãµã‚‹ ãªãŒã‚ã›ã—ã¾ã«
â€” ãŠã®ã®ã“ã¾ã¡`,
  "A04": `ã•ã³ã—ã•ã« ã‚„ã©ã‚’ãŸã¡ã„ã§ã¦ ãªãŒã‚€ã‚Œã°
ã„ã¥ã“ã‚‚ãŠãªã˜ ã‚ãã®ã‚†ã†ãã‚Œ
â€” ã‚Šã‚‡ã†ãœã‚“ã»ã†ã—`,
  "A06": `ã„ã¾ã“ã‚€ã¨ ã„ã²ã—ã°ã‹ã‚Šã« ãªãŒã¤ãã®
ã‚ã‚Šã‚ã‘ã®ã¤ãã‚’ ã¾ã¡ã„ã§ã¤ã‚‹ã‹ãª
â€” ãã›ã„ã»ã†ã—`,
  "A08": `ãŸã”ã®ã†ã‚‰ã« ã†ã¡ã„ã§ã¦ã¿ã‚Œã° ã—ã‚ãŸãˆã®
ãµã˜ã®ãŸã‹ã­ã« ã‚†ãã¯ãµã‚Šã¤ã¤
â€” ã‚„ã¾ã¹ã®ã‚ã‹ã²ã¨`,
  "A10": `ã‚ã²ã¿ã¦ã® ã®ã¡ã®ã“ã“ã‚ã« ãã‚‰ã¶ã‚Œã°
ã‚€ã‹ã—ã¯ã‚‚ã®ã‚’ ãŠã‚‚ã¯ã–ã‚Šã‘ã‚Š
â€” ãµã˜ã‚ã‚‰ã®ã‚ã¤ãŸã `,
  "A12": `ãªã’ã‘ã¨ã¦ ã¤ãã‚„ã¯ã‚‚ã®ã‚’ ãŠã‚‚ã¯ã™ã‚‹
ã‹ã“ã¡ãŒãŠãªã‚‹ ã‚ãŒãªã¿ã ã‹ãª
â€” ã•ã„ãã‚‡ã†`,
  "A14": `ã¤ãã¿ã‚Œã° ã¡ã¢ã«ã‚‚ã®ã“ã ã‹ãªã—ã‘ã‚Œ
ã‚ãŒã¿ã²ã¨ã¤ã® ã‚ãã«ã¯ã‚ã‚‰ã­ã©
â€” ãŠãŠãˆã®ã¡ã•ã¨`,
  "A16": `ã†ã‚‰ã¿ã‚ã³ ã»ã•ã¬ãã§ã ã« ã‚ã‚‹ã‚‚ã®ã‚’
ã“ã„ã«ãã¡ãªã‚€ ãªã“ãã‚’ã—ã‘ã‚Œ
â€” ã•ãŒã¿`
};
const NOTES = {
  "A02": "ç„¡å¸¸ï¼ˆè‰²ã‚ã›ï¼‰ï¼äººç”Ÿã®ã¯ã‹ãªã•ã‚’é‡ã­ã‚‹å°ç”ºã®æ­Œã€‚",
  "A04": "åºµã‹ã‚‰å¤–ã¸ä¸€æ­©â€¦ä¸–ç•Œã®ã©ã“ã‚‚åŒã˜â€œç§‹ã®å¤•æš®â€ã€‚",
  "A06": "ã€Œä»Šå¤œè¡Œãã€ã®è¨€è‘‰ã‚’ä¿¡ã˜ã¦é•·æœˆã®æœ‰æ˜æœˆã‚’å¾…ã¤æ‹ã€‚",
  "A08": "ç”°å­ã®æµ¦ã‹ã‚‰ä»°ãå¯Œå£«â€”æ¸…å†½ãªç™½é›ªã®ç¾ã®é©šãã€‚",
  "A10": "é€¢ç€¬ä»¥å¾Œã€æ‹ã®é‡ã•ã‚’çŸ¥ã‚‹â€”æ˜”ã¯çŸ¥ã‚‰ãªã‹ã£ãŸâ€œæ€ã„â€ã€‚",
  "A12": "æ‚²ã—ã¿ã®åŸå› ã¯æœˆï¼Ÿ ãã‚Œã¨ã‚‚è‡ªã‚‰ã®å¿ƒï¼Ÿ æŠ•å½±ã®æ­Œã€‚",
  "A14": "ç§ã²ã¨ã‚Šã®ç§‹ã§ã¯ãªã„â€”ç§æƒ…ã¨æ™®éã®å­£ç¯€ã®å…±é³´ã€‚",
  "A16": "æ‹ã«æœ½ã¡ã‚†ãåâ€”--è©•åˆ¤ã‚‚å¿ƒã‚‚ã€æ‹ã®è’æ³¢ã§ã€‚"
};
const AUDIO_JA = { /* ä»»æ„ï¼šç›´ãƒªãƒ³ã‚¯ã‚’å…¥ã‚Œã‚‹ã¨JAãƒœã‚¿ãƒ³ã§å„ªå…ˆå†ç”Ÿ */ };

const NEXT_LINK_FOR = (key)=> "https://hatoniwa.github.io/Pharaoh-game/part3_hub.html?v=DEMO";

/* ========= ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========= */
const $ = (id)=>document.getElementById(id);
const N = 7;
const vp=$('vp'), grid=$('grid'), img=$('displayImg'), overlay=$('textOverlay');
const videoWrap=$('videoWrap'), video=$('video'), vctrl=$('vctrl');
const notice=$('notice'), noticeLink=$('noticeLink'), help=$('help'), caption=$('caption');
const pick=$('pick'), modeSel=$('mode'), tapBtn=$('tapBtn'), autoPairCk=$('autoPair'), lyricsMode=$('lyricsMode');
const speakJaBtn=$('speakJaBtn'), speakEnBtn=$('speakEnBtn'), explainBtn=$('explainBtn'), openLinkBtn=$('openLinkBtn');
const prevBtn=$('prevBtn'), nextBtn=$('nextBtn');
const togglePlayBtn=$('togglePlay'), toggleMuteBtn=$('toggleMute');

let started=false, exploded=false;

function isEvenKey(key){ const n=parseInt(key.slice(-2),10); return !isNaN(n)&&n%2===0; }
function mp4Src(key){ return `scene_${key}.mp4`; }
function jpgSrc(key){ return `scene_${key}.jpg`; }
function preloadImg(src){
  return new Promise(res=>{ const i=new Image(); i.onload=()=>res(true); i.onerror=()=>res(false); i.src=src; });
}
function checkVideo(src){
  return new Promise(res=>{
    const v=document.createElement('video');
    v.preload='metadata'; v.src=src; v.onloadedmetadata=()=>res(true); v.onerror=()=>res(false);
  });
}
function setCaptionText(t){ caption.textContent=t; }

/* ====== 49ã‚¿ã‚¤ãƒ«ï¼ˆjpgãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚ï¼‰ ====== */
function buildTiles(src){
  grid.innerHTML='';
  const r=vp.getBoundingClientRect(), W=r.width, H=r.height, cw=W/N, ch=H/N;
  for(let y=0;y<N;y++){
    for(let x=0;x<N;x++){
      const d=document.createElement('div'); d.className='tile';
      Object.assign(d.style,{
        left:(x*cw)+'px', top:(y*ch)+'px', width:Math.ceil(cw)+'px', height:Math.ceil(ch)+'px',
        backgroundImage:`url(${src})`, backgroundSize:`${W}px ${H}px`, backgroundPosition:`-${x*cw}px -${y*ch}px`,
        transform:'translate(0,0) rotate(0) scale(1)', opacity:'1'
      });
      grid.appendChild(d);
    }
  }
  grid.style.display='block'; img.style.display='none';
}
function explode(){
  const r=vp.getBoundingClientRect(), W=r.width, H=r.height;
  for(const d of grid.children){
    const dx=(Math.random()-.5)*W*1.8, dy=(Math.random()-.5)*H*1.8, rot=(Math.random()-.5)*120;
    d.style.transitionDelay=(Math.random()*380)+'ms';
    d.style.transform=`translate(${dx}px,${dy}px) rotate(${rot}deg) scale(${0.9+Math.random()*0.2})`;
    d.style.opacity='0';
  }
}
function gather(){
  for(const d of grid.children){
    d.style.transitionDelay=(Math.random()*180)+'ms';
    d.style.transform='translate(0,0) rotate(0) scale(1)';
    d.style.opacity='1';
  }
}

/* ====== ãƒ†ã‚­ã‚¹ãƒˆ ====== */
function textFor(key){
  return (lyricsMode.value==='hira' ? (TEXT_HIRA[key]||'(ã²ã‚‰ãŒãªæœªç™»éŒ²)') : (TEXT_EN[key]||'(No English text)'));
}

/* ====== ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ====== */
async function render(){
  if(!started) return;
  const key=pick.value, mode=String(modeSel.value||'').toLowerCase();

  // reset
  notice.style.display='none';
  overlay.style.display='none'; overlay.style.opacity='0';
  grid.style.display='none'; img.style.display='none';
  videoWrap.style.display='none'; vctrl.style.display='none';
  if(!isEvenKey(key)) tapBtn.style.display='block';

  setCaptionText(`${key} â€” ${isEvenKey(key)?`Text [${lyricsMode.value}]`:'Visual'} | Mode: ${mode.toUpperCase()}`);

  if(mode==='notice'){
    noticeLink.href = NEXT_LINK_FOR(key);
    notice.style.display='flex'; tapBtn.style.display='none'; exploded=false; return;
  }

  if(isEvenKey(key) || mode==='explain'){
    overlay.innerHTML = `<p>${textFor(key).replace(/\n/g,'<br>')}</p>`;
    overlay.style.display='flex';
    requestAnimationFrame(()=> overlay.style.opacity='1');
    tapBtn.style.display='none'; exploded=false; return;
  }

  // å¥‡æ•°ï¼šã¾ãš mp4 ã‚’æ¢ã™ â†’ ãªã‘ã‚Œã° jpg çˆ†æ•£
  const vsrc = mp4Src(key);
  if(await checkVideo(vsrc)){
    // å‹•ç”»ãƒ¢ãƒ¼ãƒ‰
    video.src = vsrc;
    videoWrap.style.display='block';
    vctrl.style.display='flex';
    // Tapå¾Œãªã®ã§è‡ªå‹•å†ç”ŸOKï¼ˆãƒ¢ãƒã‚¤ãƒ«ã¯ muted å¿…é ˆï¼‰
    try{ await video.play(); }catch(_){}
    tapBtn.style.display='none'; // å‹•ç”»ã¯ã‚¿ãƒƒãƒ—ä¸è¦
    exploded=false;
  }else{
    // ç”»åƒãƒ¢ãƒ¼ãƒ‰ï¼ˆå¾“æ¥ã©ãŠã‚Šï¼‰
    const src = jpgSrc(key);
    if(await preloadImg(src)){
      buildTiles(src);
      explode(); exploded=true;
    }else{
      img.src=src; img.alt=`Failed to load ${src}`;
      img.style.display='block'; tapBtn.style.display='none'; exploded=false;
    }
  }
}

/* ====== éŸ³å£° / è§£èª¬ / ãƒŠãƒ“ ====== */
function speak(text, lang){
  try{
    if('speechSynthesis' in window){
      window.speechSynthesis.cancel();
      const u=new SpeechSynthesisUtterance(text.replace(/<[^>]+>/g,' '));
      u.lang=lang; u.rate=1; u.pitch=1; u.volume=1; window.speechSynthesis.speak(u); return true;
    }
  }catch(_){}
  return false;
}
function getTextEn(){ return TEXT_EN[pick.value]||''; }
function getTextHira(){ return TEXT_HIRA[pick.value]||''; }
function showNote(){
  const note = NOTES[pick.value]; if(!note) return;
  overlay.innerHTML = `<p>${note}</p>`; overlay.style.display='flex';
  requestAnimationFrame(()=> overlay.style.opacity='1');
  setTimeout(()=>{ overlay.style.opacity='0'; setTimeout(()=> overlay.style.display='none', 300); }, 3000);
}
function idx(){ return [...pick.options].findIndex(o=>o.value===pick.value); }
function keyAt(i){ const opts=[...pick.options]; return (i<0||i>=opts.length)?null:opts[i].value; }
function go(off){ const k=keyAt(idx()+off); if(!k) return; pick.value=k; render(); }

// å„è¡¨ç¤ºè¦ç´ ã‚’ä¸€åº¦ã«éè¡¨ç¤ºã«ã™ã‚‹é–¢æ•°
function resetUI() {
  notice.style.display = 'none';
  overlay.style.display = 'none';
  overlay.style.opacity = '0';
  grid.style.display = 'none';
  img.style.display = 'none';
  videoWrap.style.display = 'none';
  vctrl.style.display = 'none';
  tapBtn.style.display = 'none';
}

// å‹•ç”»ãƒ¢ãƒ¼ãƒ‰ã®UIã‚’è¨­å®šã™ã‚‹é–¢æ•°
function setVideoMode(key, src) {
  resetUI();
  video.src = src;
  videoWrap.style.display = 'block';
  vctrl.style.display = 'flex';
  setCaptionText(`${key} â€” Visual | Mode: AUTO`);
  try {
    video.play();
  } catch (_) {}
}

// ç”»åƒãƒ¢ãƒ¼ãƒ‰ã®UIã‚’è¨­å®šã™ã‚‹é–¢æ•°
function setGridMode(key, src) {
  resetUI();
  buildTiles(src);
  explode();
  exploded = true;
  tapBtn.style.display = 'block'; // ç”»åƒçˆ†æ•£ã¯ã‚¿ãƒƒãƒ—ã§åˆ¶å¾¡
  setCaptionText(`${key} â€” Visual | Mode: AUTO`);
}

// ãƒ†ã‚­ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã®UIã‚’è¨­å®šã™ã‚‹é–¢æ•°
function setTextMode(key) {
  resetUI();
  overlay.innerHTML = `<p>${textFor(key).replace(/\n/g, '<br>')}</p>`;
  overlay.style.display = 'flex';
  requestAnimationFrame(() => overlay.style.opacity = '1');
  setCaptionText(`${key} â€” Text [${lyricsMode.value}] | Mode: AUTO`);
}

// é€šçŸ¥ãƒ¢ãƒ¼ãƒ‰ã®UIã‚’è¨­å®šã™ã‚‹é–¢æ•°
function setNoticeMode(key) {
  resetUI();
  noticeLink.href = NEXT_LINK_FOR(key);
  notice.style.display = 'flex';
  exploded = false;
  setCaptionText(`${key} â€” Text [${lyricsMode.value}] | Mode: NOTICE`);
}

async function render() {
  if (!started) return;
  const key = pick.value;
  const mode = String(modeSel.value || '').toLowerCase();

  // ã¾ãšã€UIã‚’ãƒªã‚»ãƒƒãƒˆ
  resetUI();

  // ãƒ¢ãƒ¼ãƒ‰ã”ã¨ã®å‡¦ç†
  if (mode === 'notice') {
    setNoticeMode(key);
    return;
  }
  if (isEvenKey(key) || mode === 'explain') {
    setTextMode(key);
    return;
  }

  // å¥‡æ•°ç•ªï¼ˆå‹•ç”»ãƒ»ç”»åƒï¼‰ã®å‡¦ç†
  const vsrc = mp4Src(key);
  const jsrc = jpgSrc(key);

  // 1. ã¾ãšå‹•ç”»ã®å­˜åœ¨ã‚’ãƒã‚§ãƒƒã‚¯
  const videoExists = await checkVideo(vsrc);
  if (videoExists) {
    setVideoMode(key, vsrc);
    return; // ã“ã“ã§å‡¦ç†ã‚’çµ‚äº†
  }

  // 2. å‹•ç”»ãŒãªã‘ã‚Œã°ç”»åƒã®å­˜åœ¨ã‚’ãƒã‚§ãƒƒã‚¯
  const imageExists = await preloadImg(jsrc);
  if (imageExists) {
    setGridMode(key, jsrc);
  } else {
    // ç”»åƒã‚‚ãªã‘ã‚Œã°ã€ç”»åƒãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦imgã‚¿ã‚°ã‚’è¡¨ç¤º
    resetUI();
    img.src = jsrc;
    img.alt = `Failed to load ${jsrc}`;
    img.style.display = 'block';
    setCaptionText(`${key} â€” Image not found`);
  }
}

function goPairNext(){
  const i=idx(), cur=pick.value;
  if(isEvenKey(cur)){ const k=keyAt(i+1)||keyAt(i); if(k){pick.value=k; render();} }
  else{ const k=keyAt(i+1); if(k){pick.value=k; render();} }
}

/* ====== ã‚¤ãƒ™ãƒ³ãƒˆ ====== */
tapBtn.addEventListener('click', ()=>{
  if(!started){
    started=true; help.style.display='block'; setTimeout(()=>help.style.display='none', 3500); render(); return;
  }
  if(modeSel.value==='auto' && !isEvenKey(pick.value) && grid.style.display==='block'){
    if(exploded) gather(); else explode(); exploded=!exploded;
  }
});
pick.addEventListener('change', render);
modeSel.addEventListener('change', render);
lyricsMode.addEventListener('change', render);
$('openLinkBtn').addEventListener('click', ()=> window.open(NEXT_LINK_FOR(pick.value),'_blank','noopener'));
$('explainBtn').addEventListener('click', showNote);

$('speakJaBtn').addEventListener('click', ()=>{
  const key=pick.value, mp3=AUDIO_JA[key];
  if(mp3){ new Audio(mp3).play().catch(()=>{}); return; }
  // â€œæ—¥æœ¬èªé¢¨ã«è‹±èªã‚’èª­ã‚€â€ç¶™æ‰¿ï¼šç¾åœ¨è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã«åˆã‚ã›ã¦
  const t = (lyricsMode.value==='hira') ? getTextHira() : getTextEn();
  speak(t,'ja-JP');
});
$('speakEnBtn').addEventListener('click', ()=> speak(getTextEn(),'en-US'));

$('prevBtn').addEventListener('click', ()=> go(-1));
$('nextBtn').addEventListener('click', ()=>{ autoPairCk.checked ? goPairNext() : go(1); });

/* å‹•ç”»ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
togglePlayBtn.addEventListener('click', ()=>{
  if(video.paused){ video.play().catch(()=>{}); } else { video.pause(); }
});
toggleMuteBtn.addEventListener('click', ()=>{ video.muted = !video.muted; });

window.addEventListener('resize', ()=>{ if(started) render(); });
window.addEventListener('keydown', (e)=>{
  if(e.key==='ArrowLeft') $('prevBtn').click();
  if(e.key==='ArrowRight') $('nextBtn').click();
});
</script>
</body>
</html>