<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hyakunin Isshu â€” Ultimate Viewer</title>
<style>
  :root{
    --w:720px; --fg:#fff; --ui:#1a1a1a; --bd:#333; --acc:#ffd54a;
    --btn:#ccc; --btnText:#3fa34d; --muted:#bbb; --shadow:0 8px 24px rgba(0,0,0,.35);
    --aspect:56.25%;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:#101014; color:var(--fg);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", Meiryo, sans-serif;
    min-height:100vh; display:flex; align-items:center; justify-content:center; padding:18px;
  }
  .app{ width:min(var(--w), 96vw); }
  .bar{
    display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:8px 0 12px;
  }
  label, select, button{
    background:var(--ui); color:#fff; border:1px solid var(--bd); border-radius:10px;
    padding:8px 12px; font-size:14px;
  }
  select{ cursor:pointer }
  button{ cursor:pointer }
  .ghost{ opacity:.65 }

  .stage{
    position:relative; width:100%; border:1px solid #222; border-radius:14px;
    background:#000; overflow:hidden; box-shadow:var(--shadow);
  }
  .stage::before{ content:""; display:block; padding-top:var(--aspect); } /* 16:9 */
  .viewport{ position:absolute; inset:0; }

  /* å˜ç”»åƒï¼ˆå¶æ•°ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã«ã‚‚ï¼‰ */
  #displayImg{ width:100%; height:100%; object-fit:contain; display:none; }

  /* 49ã‚¿ã‚¤ãƒ«ï¼ˆå¥‡æ•°ï¼çµµï¼‰ */
  .grid7{ position:absolute; inset:0; display:none; }
  .grid7 .tile{
    position:absolute; background-repeat:no-repeat;
    transition: transform 1.05s ease, opacity 1.05s ease;
    will-change: transform, opacity;
  }

  /* è‹±è¨³ãƒ†ã‚­ã‚¹ãƒˆã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆå¶æ•°ï¼‰ */
  .text-overlay{
    position:absolute; inset:0; display:none;
    flex-direction:column; justify-content:center; align-items:center; text-align:center;
    padding:20px; background:rgba(0,0,0,.72); color:#fff; line-height:1.6; font-size:20px;
    opacity:0; transition:opacity .45s ease;
  }
  .text-overlay p{ margin:0 }
  .text-overlay .author{ margin-top:10px; color:var(--acc); font-style:italic; font-size:16px }

  /* ãƒ˜ãƒ«ãƒ—ï¼ˆæœ€åˆã ã‘ï¼‰ */
  .help{
    position:absolute; inset:auto 12px 12px 12px; padding:10px 12px;
    background:rgba(0,0,0,.65); border:1px solid #444; border-radius:10px; font-size:13px;
    display:none;
  }

  /* èª˜å°ï¼ˆç¬¬ä¸‰éƒ¨ãªã©ï¼‰ */
  .notice{
    position:absolute; inset:0; display:none; flex-direction:column; gap:14px;
    justify-content:center; align-items:center; text-align:center;
    background:rgba(0,0,0,.85); color:#fff; font-weight:700; font-size:20px; padding:20px;
  }
  .notice a{
    display:inline-block; padding:10px 14px; border-radius:8px; text-decoration:none;
    background:var(--btn); color:var(--btnText); border:1px solid #999; font-weight:700;
  }

  /* æ“ä½œãƒœã‚¿ãƒ³ */
  .tools{
    position:absolute; left:12px; top:12px; display:flex; gap:6px; z-index:5;
  }
  .tools button{
    background:#1b1b1f; border-color:#2f2f33; padding:6px 10px; border-radius:8px; font-size:13px;
  }
  .nav{
    position:absolute; right:12px; top:12px; display:flex; gap:6px; z-index:5;
  }
  .nav button{ background:#1b1b1f; border-color:#2f2f33; padding:6px 10px; border-radius:8px; font-size:13px }

  /* æœ€åˆã®ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ï¼ˆå·¦ä¸‹ï¼‰ */
  #tapBtn{
    position:absolute; left:16px; bottom:16px; z-index:6;
    background:var(--btn); color:var(--btnText); border:1px solid #999; border-radius:10px;
    font-weight:800; font-size:14px; padding:10px 14px;
  }

  /* ä¸‹éƒ¨ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼ˆç¾åœ¨ä½ç½®ãªã©ï¼‰ */
  .caption{
    position:absolute; left:0; right:0; bottom:0; padding:10px 12px;
    background:linear-gradient(180deg,rgba(0,0,0,0) 0%,rgba(0,0,0,.65) 45%,rgba(0,0,0,.78) 100%);
    font-size:13px; color:#ddd;
  }
</style>
</head>
<body>
<div class="app">

  <!-- ä¸Šéƒ¨ãƒãƒ¼ -->
  <div class="bar">
    <label>Pick
      <select id="pick">
        <!-- TODO: å¿…è¦ã«å¿œã˜ã¦é †åºå¤‰æ›´OKï¼ˆå¥‡æ•°=çµµ / å¶æ•°=è‹±è¨³ï¼‰ -->
        <option value="A01">A01 â€” Komachi (art)</option>
        <option value="A02">A02 â€” Komachi (EN)</option>
        <option value="A03">A03 â€” RyÅzen (art)</option>
        <option value="A04">A04 â€” RyÅzen (EN)</option>
        <option value="A05">A05 â€” Sosei (art)</option>
        <option value="A06">A06 â€” Sosei (EN)</option>
        <option value="A07">A07 â€” Akahito (art)</option>
        <option value="A08">A08 â€” Akahito (EN)</option>
        <option value="A09">A09 â€” Atsutada (art)</option>
        <option value="A10">A10 â€” Atsutada (EN)</option>
        <option value="A11">A11 â€” SaigyÅ (art)</option>
        <option value="A12">A12 â€” SaigyÅ (EN)</option>
        <option value="A13">A13 â€” ÅŒe no Chisato (art)</option>
        <option value="A14">A14 â€” ÅŒe no Chisato (EN)</option>
        <option value="A15">A15 â€” Sagami (art)</option>
        <option value="A16" selected>A16 â€” Sagami (EN)</option>
      </select>
    </label>

    <label>Mode
      <select id="mode">
        <option value="auto" selected>Autoï¼ˆodd=explode / even=textï¼‰</option>
        <option value="explain">Explain only</option>
        <option value="notice">ğŸ‘‰ Check the description</option>
      </select>
    </label>

    <span class="sp"></span>

    <!-- ã“ã“ã¯ â€œãŠå¥½ã¿ã§â€ æ©Ÿèƒ½ON/OFF -->
    <label class="ghost"><input type="checkbox" id="autoPair" checked /> Pair advance</label>
  </div>

  <!-- ã‚¹ãƒ†ãƒ¼ã‚¸ -->
  <div class="stage">
    <div class="viewport" id="vp">

      <!-- å·¦ä¸Šãƒ„ãƒ¼ãƒ« -->
      <div class="tools">
        <button id="speakJaBtn" title="Japanese voice">ğŸ”Š JA</button>
        <button id="speakEnBtn" title="English voice">ğŸ”Š EN</button>
        <button id="explainBtn" title="Show brief note">â„¹ Explain</button>
        <button id="openLinkBtn" title="Open next link">â†— Open</button>
      </div>

      <!-- å³ä¸ŠãƒŠãƒ“ -->
      <div class="nav">
        <button id="prevBtn" title="Previous (â†)">â® Prev</button>
        <button id="nextBtn" title="Next (â†’)">â­ Next</button>
      </div>

      <img id="displayImg" alt="">
      <div id="grid" class="grid7"></div>
      <div id="textOverlay" class="text-overlay"></div>

      <div id="help" class="help">
        Tapã€ŒTap Hereã€to start.  
        â®/â­ to move, ğŸ”Š to listen, â„¹ to read note, â†— opens the link.
      </div>

      <button id="tapBtn" type="button">Tap Here</button>

      <div class="notice" id="notice">
        ğŸ‘‰ This is not the end!<br>
        Please open the description link below.
        <!-- TODO: å®ŸURLã«å·®ã—æ›¿ãˆ -->
        <a id="noticeLink" href="https://hatoniwa.github.io/Pharaoh-game/part3_hub.html?v=DEMO" target="_blank" rel="noopener">Open Interactive Page â†—</a>
      </div>

      <div id="caption" class="caption"></div>
    </div>
  </div>
</div>

<script>
/* ========= ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ========= */

/* è‹±è¨³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå¶æ•°ã‚­ãƒ¼ï¼‰ */
const TEXT_DATA = {
  "A02": `<p>The colors of flowers fade away in vain,<br>as in this fleeting world my life drifts on in rains.</p><p class="author">â€” Ono no Komachi</p>`,
  "A04": `<p>Lonely, I stepped outside my hut and lookedâ€”<br>everywhere the same: an autumn evening.</p><p class="author">â€” RyÅzen HÅshi</p>`,
  "A06": `<p>â€œI'll come tonight,â€ you said â€” so I stayed awake,<br>waiting for the long-month's dawning moon.</p><p class="author">â€” Sosei HÅshi</p>`,
  "A08": `<p>At Tago Bay I came out and beheld:<br>pure white snow on Fujiâ€™s lofty peak.</p><p class="author">â€” Yamabe no Akahito</p>`,
  "A10": `<p>Compared with how my heart has been since we met,<br>in former days I scarcely knew longing.</p><p class="author">â€” Fujiwara no Atsutada</p>`,
  "A12": `<p>â€œLament!â€â€”does the moon make me grieve?<br>Noâ€”my tears themselves blame the moon.</p><p class="author">â€” SaigyÅ</p>`,
  "A14": `<p>Seeing the moon, a thousand sorrows surgeâ€”<br>though autumn is not mine alone.</p><p class="author">â€” ÅŒe no Chisato</p>`,
  "A16": `<p>Weary of resentment, though even dry sleeves remain,<br>my name will wither away in loveâ€™s decay.</p><p class="author">â€” Sagami</p>`
};

/* çŸ­ã„è§£èª¬ï¼ˆâ„¹ãƒœã‚¿ãƒ³ã§3ç§’è¡¨ç¤ºï¼‰ */
const NOTES_DATA = {
  "A02": "Komachiâ€™s poem on impermanenceâ€”colors fading = lifeâ€™s ephemerality.",
  "A04": "A hut, a glance, and the whole world is eveningâ€”wabi-sabi of solitude.",
  "A06": "Love meets time: waiting through the â€˜long monthâ€™ for the moon that never comes.",
  "A08": "Tago Bay frame opens to the iconic, snow-capped Fuji: awe in clarity.",
  "A10": "Only after love does â€˜longingâ€™ gain its weightâ€”an awakening of the heart.",
  "A12": "Who causes sorrow? The moon, or the self that projects onto it.",
  "A14": "Shared autumn: private sadness meets universal season.",
  "A16": "Reputation erodes under loveâ€™s stormsâ€”name and feeling entwined."
};

/* ï¼ˆä»»æ„ï¼‰æ—¥æœ¬èªéŸ³å£°mp3ç›´ãƒªãƒ³ã‚¯ï¼šã‚ã‚Œã°TTSã‚ˆã‚Šå„ªå…ˆ
   ä¾‹: AUDIO_JA["A02"] = "https://.../A02_ja.mp3";
*/
const AUDIO_JA = {};

/* æ¬¡ãƒªãƒ³ã‚¯ï¼ˆâ†— Openï¼‰â€” YouTubeèª¬æ˜æ¬„ã®ãƒªãƒ³ã‚¯å…ˆã«åˆã‚ã›ã¦ */
const NEXT_LINK_FOR = (key)=> {
  // TODO: å®Ÿé‹ç”¨ã§ã¯ä½œå“ã”ã¨ã«åˆ†ã‘ãŸã„å ´åˆã“ã“ã§åˆ†å²
  return "https://hatoniwa.github.io/movideo-docks-ccmovid/gg-intro.html ";
};

/* ========= ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========= */

const $ = (id)=>document.getElementById(id);
const N = 7;

const vp = $('vp'), grid = $('grid'), img = $('displayImg'), overlay = $('textOverlay');
const notice = $('notice'), noticeLink = $('noticeLink');
const help = $('help'), caption = $('caption');
const pick = $('pick'), modeSel = $('mode'), tapBtn = $('tapBtn'), autoPairCk = $('autoPair');

const speakJaBtn = $('speakJaBtn'), speakEnBtn = $('speakEnBtn'), explainBtn = $('explainBtn'), openLinkBtn = $('openLinkBtn');
const prevBtn = $('prevBtn'), nextBtn = $('nextBtn');

let started = false, exploded = false;

function isEvenKey(key){
  const n = parseInt(key.slice(-2), 10);
  return !isNaN(n) && n%2===0;
}
function imgSrc(key){
  // ã‚ãªãŸã®ç”»åƒåè¦å‰‡ï¼ˆscene_A01.jpg ãªã©ï¼‰
  return `scene_${key}.jpg`;
}
function preload(src){
  return new Promise(res=>{
    const i=new Image();
    i.onload=()=>res(true);
    i.onerror=()=>res(false);
    i.src=src;
  });
}
function setCaption(text){
  caption.textContent = text;
}

/* ============ 49ã‚¿ã‚¤ãƒ«ç”Ÿæˆ/ã‚¢ãƒ‹ãƒ¡ ============ */
function buildTiles(src){
  grid.innerHTML='';
  const r = vp.getBoundingClientRect(), W=r.width, H=r.height;
  const cw=W/N, ch=H/N;
  for(let y=0;y<N;y++){
    for(let x=0;x<N;x++){
      const d=document.createElement('div');
      d.className='tile';
      Object.assign(d.style,{
        left:(x*cw)+'px', top:(y*ch)+'px', width:Math.ceil(cw)+'px', height:Math.ceil(ch)+'px',
        backgroundImage:`url(${src})`, backgroundSize:`${W}px ${H}px`, backgroundPosition:`-${x*cw}px -${y*ch}px`,
        transform:'translate(0,0) rotate(0) scale(1)', opacity:'1'
      });
      grid.appendChild(d);
    }
  }
  grid.style.display='block';
  img.style.display='none';
}
function explode(){
  const r=vp.getBoundingClientRect(), W=r.width, H=r.height;
  for(const d of grid.children){
    const dx=(Math.random()-.5)*W*1.8, dy=(Math.random()-.5)*H*1.8, rot=(Math.random()-.5)*120;
    d.style.transitionDelay=(Math.random()*380)+'ms';
    d.style.transform=`translate(${dx}px,${dy}px) rotate(${rot}deg) scale(${0.9+Math.random()*0.2})`;
    d.style.opacity='0';
  }
}
function gather(){
  for(const d of grid.children){
    d.style.transitionDelay=(Math.random()*180)+'ms';
    d.style.transform='translate(0,0) rotate(0) scale(1)';
    d.style.opacity='1';
  }
}

/* ============ è¡¨ç¤ºãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ============ */
async function render(){
  if(!started) return;

  const key = pick.value;
  const mode = String(modeSel.value||'').toLowerCase();

  // åˆæœŸåŒ–
  notice.style.display='none';
  overlay.style.display='none'; overlay.style.opacity='0';
  grid.style.display='none';
  img.style.display='none';
  tapBtn.style.display = isEvenKey(key) ? 'none' : 'block';
  setCaption(`${key} â€” ${isEvenKey(key)?'EN Text':'Art (grid)'} | Mode: ${mode.toUpperCase()}`);

  if(mode==='notice'){
    noticeLink.href = NEXT_LINK_FOR(key);
    notice.style.display='flex';
    tapBtn.style.display='none';
    exploded=false;
    return;
  }

  if(isEvenKey(key) || mode==='explain'){
    // å¶æ•°ï¼è‹±è¨³ or èª¬æ˜ã®ã¿ãƒ¢ãƒ¼ãƒ‰
    const html = TEXT_DATA[key] || `<p style="color:#bbb">No text for ${key}</p>`;
    overlay.innerHTML = html;
    overlay.style.display='flex';
    requestAnimationFrame(()=> overlay.style.opacity='1');
    tapBtn.style.display='none';
    exploded=false;
  }else{
    // å¥‡æ•°ï¼çµµï¼ˆã‚°ãƒªãƒƒãƒ‰ï¼‰
    const src = imgSrc(key);
    if(await preload(src)){
      buildTiles(src);
      explode();
      exploded=true;
    }else{
      img.src=src; img.alt=`Failed to load ${src}`;
      img.style.display='block';
      tapBtn.style.display='none';
      exploded=false;
    }
  }
}

/* ============ éŸ³å£° / è§£èª¬ / ãƒŠãƒ“ ============ */
function speak(text, lang){
  try{
    if('speechSynthesis' in window){
      window.speechSynthesis.cancel();
      const u=new SpeechSynthesisUtterance(text.replace(/<[^>]+>/g,' '));
      u.lang=lang; u.rate=1; u.pitch=1; u.volume=1;
      window.speechSynthesis.speak(u);
      return true;
    }
  }catch(_){}
  return false;
}
function getTextEn(){ return TEXT_DATA[pick.value]||''; }
function getTextJa(){
  const mp3=AUDIO_JA[pick.value];
  if(mp3){ new Audio(mp3).play().catch(()=>{}); return ''; }
  // æš«å®šï¼šè‹±è¨³ã‚’æ—¥æœ¬èªéŸ³å£°ã§èª­ã¿ä¸Šã’ï¼ˆå¾Œã§å’Œè¨³ã«å·®ã—æ›¿ãˆã¦OKï¼‰
  return getTextEn();
}
function showNote(){
  const key=pick.value, note=NOTES_DATA[key];
  if(!note) return;
  help.style.display='none';
  overlay.innerHTML = `<p>${note}</p>`;
  overlay.style.display='flex';
  requestAnimationFrame(()=> overlay.style.opacity='1');
  setTimeout(()=>{
    overlay.style.opacity='0';
    setTimeout(()=> overlay.style.display='none', 300);
  }, 3000);
}
function idxOfKey(key){
  const opts=[...pick.options];
  return opts.findIndex(o=>o.value===key);
}
function keyAt(i){
  const opts=[...pick.options];
  if(i<0||i>=opts.length) return null;
  return opts[i].value;
}
function go(offset){
  const i=idxOfKey(pick.value);
  const k=keyAt(i+offset);
  if(!k) return;
  pick.value=k;
  render();
}
function goPairNext(){
  // å¥‡æ•°â†’å¶æ•°â†’æ¬¡ã®å¥‡æ•°â€¦ã¨é€²ã‚€
  const i=idxOfKey(pick.value);
  const cur=pick.value;
  if(isEvenKey(cur)){
    // å¶æ•°ãªã‚‰æ¬¡ã®å¥‡æ•°ã¸
    const nextKey = keyAt(i+1) || keyAt(i); // æœ«å°¾å®‰å…¨
    if(nextKey){ pick.value=nextKey; render(); }
  }else{
    // å¥‡æ•°ãªã‚‰éš£ã®å¶æ•°ã¸
    const evenKey = keyAt(i+1);
    if(evenKey){ pick.value=evenKey; render(); }
  }
}

/* ============ ã‚¤ãƒ™ãƒ³ãƒˆ ============ */
tapBtn.addEventListener('click', ()=>{
  if(!started){
    started=true;
    help.style.display='block';
    setTimeout(()=> help.style.display='none', 3500);
    render();
    return;
  }
  if(modeSel.value==='auto' && !isEvenKey(pick.value)){
    if(exploded) gather(); else explode();
    exploded=!exploded;
  }
});

pick.addEventListener('change', render);
modeSel.addEventListener('change', render);
autoPairCk.addEventListener('change', ()=>{ /* ä½•ã‚‚ã—ãªã„ï¼ˆãƒˆã‚°ãƒ«ã ã‘ï¼‰ */ });

speakJaBtn.addEventListener('click', ()=>{
  const t=getTextJa(); if(t) speak(t,'ja-JP');
});
speakEnBtn.addEventListener('click', ()=>{
  const t=getTextEn(); if(t) speak(t,'en-US');
});
explainBtn.addEventListener('click', showNote);
openLinkBtn.addEventListener('click', ()=>{
  window.open(NEXT_LINK_FOR(pick.value), '_blank', 'noopener');
});

prevBtn.addEventListener('click', ()=> go(-1));
nextBtn.addEventListener('click', ()=>{
  if(autoPairCk.checked) goPairNext(); else go(1);
});

window.addEventListener('resize', ()=>{ if(started) render(); });
window.addEventListener('keydown', (e)=>{
  if(e.key==='ArrowLeft') prevBtn.click();
  if(e.key==='ArrowRight') nextBtn.click();
});

/* åˆæœŸåŒ–ï¼šåˆå›ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¯Tapå¾Œ */
</script>
</body>
</html>
